# Demo Gin API æ•°æ®åº“è®¾è®¡æ–‡æ¡£

> ğŸ—„ï¸ æ•°æ®åº“: PostgreSQL
> ğŸ› ï¸ å·¥å…·é“¾: sqlc + æ•°æ®åº“è¿ç§»
> ğŸ“Š è®¾è®¡åŸåˆ™: è§„èŒƒåŒ–ã€æ€§èƒ½ä¼˜åŒ–ã€æ•°æ®å®Œæ•´æ€§

---

## ğŸ“‹ æ•°æ®åº“æ¦‚è§ˆ

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| æ•°æ®åº“ç±»å‹ | PostgreSQL |
| è¡¨æ•°é‡ | 2 |
| ç´¢å¼•æ•°é‡ | 5 |
| è§¦å‘å™¨æ•°é‡ | 2 |
| å¤–é”®çº¦æŸ | 1 |

---

## ğŸ—‚ï¸ è¡¨ç»“æ„è®¾è®¡

### ğŸ‘¤ users è¡¨ (ç”¨æˆ·ä¿¡æ¯)

```sql
CREATE TABLE IF NOT EXISTS users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè‡ªå¢ä¸»é”® |
| `email` | VARCHAR(255) | UNIQUE NOT NULL | ç”¨æˆ·é‚®ç®±ï¼Œç”¨äºç™»å½•å’Œé€šçŸ¥ |
| `username` | VARCHAR(100) | UNIQUE NOT NULL | ç”¨æˆ·åï¼Œç”¨äºç™»å½•å’Œæ˜¾ç¤º |
| `password_hash` | VARCHAR(255) | NOT NULL | bcryptåŠ å¯†åçš„å¯†ç å“ˆå¸Œ |
| `full_name` | VARCHAR(255) | NULL | ç”¨æˆ·çœŸå®å§“åï¼Œå¯é€‰å­—æ®µ |
| `is_active` | BOOLEAN | DEFAULT true | è´¦æˆ·æ¿€æ´»çŠ¶æ€ï¼Œæ”¯æŒè½¯åˆ é™¤ |
| `created_at` | TIMESTAMPTZ | DEFAULT NOW() | è´¦æˆ·åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMPTZ | DEFAULT NOW() | æœ€åæ›´æ–°æ—¶é—´ï¼Œè§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤ |

#### ä¸šåŠ¡è§„åˆ™
- é‚®ç®±å’Œç”¨æˆ·åå¿…é¡»å…¨å±€å”¯ä¸€
- å¯†ç ä½¿ç”¨ bcrypt ç®—æ³•åŠ å¯†å­˜å‚¨
- æ”¯æŒè½¯åˆ é™¤æœºåˆ¶ï¼ˆis_activeå­—æ®µï¼‰
- æ—¶é—´å­—æ®µåŒ…å«æ—¶åŒºä¿¡æ¯

### ğŸ“ posts è¡¨ (æ–‡ç« å†…å®¹)

```sql
CREATE TABLE IF NOT EXISTS posts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    status VARCHAR(50) DEFAULT 'draft',
    published_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

#### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | æ–‡ç« å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œè‡ªå¢ä¸»é”® |
| `user_id` | INTEGER | FK NOT NULL | æ–‡ç« ä½œè€…IDï¼Œå¤–é”®å…³è”usersè¡¨ |
| `title` | VARCHAR(255) | NOT NULL | æ–‡ç« æ ‡é¢˜ï¼Œé™åˆ¶é•¿åº¦é˜²æ­¢è¿‡é•¿ |
| `content` | TEXT | NULL | æ–‡ç« æ­£æ–‡å†…å®¹ï¼Œæ”¯æŒé•¿æ–‡æœ¬ |
| `status` | VARCHAR(50) | DEFAULT 'draft' | æ–‡ç« çŠ¶æ€ï¼šdraft/published/archived |
| `published_at` | TIMESTAMPTZ | NULL | æ–‡ç« å‘å¸ƒæ—¶é—´ï¼Œä»…å‘å¸ƒæ—¶è®¾ç½® |
| `created_at` | TIMESTAMPTZ | DEFAULT NOW() | æ–‡ç« åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMPTZ | DEFAULT NOW() | æœ€åæ›´æ–°æ—¶é—´ï¼Œè§¦å‘å™¨è‡ªåŠ¨ç»´æŠ¤ |

#### æ–‡ç« çŠ¶æ€æµè½¬
```mermaid
stateDiagram-v2
    [*] --> draft : åˆ›å»ºæ–‡ç« 
    draft --> published : å‘å¸ƒæ–‡ç« 
    draft --> archived : å½’æ¡£è‰ç¨¿
    published --> archived : å½’æ¡£æ–‡ç« 
    published --> draft : æ’¤å›å‘å¸ƒï¼ˆå¯é€‰ï¼‰
```

#### å¤–é”®çº¦æŸ
- `user_id` â†’ `users.id` (ON DELETE CASCADE)
- å½“ç”¨æˆ·è¢«åˆ é™¤æ—¶ï¼Œå…¶æ‰€æœ‰æ–‡ç« è‡ªåŠ¨åˆ é™¤

---

## ğŸš€ ç´¢å¼•è®¾è®¡ç­–ç•¥

### æ€§èƒ½ä¼˜åŒ–ç´¢å¼•

```sql
-- ç”¨æˆ·è¡¨ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);

-- æ–‡ç« è¡¨ç´¢å¼•
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_status ON posts(status);
CREATE INDEX idx_posts_published_at ON posts(published_at);
```

### ç´¢å¼•ä½¿ç”¨åœºæ™¯åˆ†æ

| ç´¢å¼• | ä½¿ç”¨åœºæ™¯ | æ€§èƒ½æå‡ |
|------|----------|----------|
| `idx_users_email` | é‚®ç®±ç™»å½•æŸ¥è¯¢ | O(log n) æŸ¥æ‰¾ |
| `idx_users_username` | ç”¨æˆ·åç™»å½•æŸ¥è¯¢ | O(log n) æŸ¥æ‰¾ |
| `idx_posts_user_id` | æŒ‰ä½œè€…æŸ¥è¯¢æ–‡ç«  | é¿å…å…¨è¡¨æ‰«æ |
| `idx_posts_status` | æŒ‰çŠ¶æ€ç­›é€‰æ–‡ç«  | çŠ¶æ€è¿‡æ»¤åŠ é€Ÿ |
| `idx_posts_published_at` | æŒ‰å‘å¸ƒæ—¶é—´æ’åº | æ—¶é—´èŒƒå›´æŸ¥è¯¢ä¼˜åŒ– |

### å¤åˆç´¢å¼•è€ƒè™‘
```sql
-- é’ˆå¯¹å¸¸è§æŸ¥è¯¢æ¨¡å¼çš„å¤åˆç´¢å¼•ï¼ˆå¯é€‰ï¼‰
CREATE INDEX idx_posts_status_published ON posts(status, published_at DESC)
WHERE status = 'published';
```

---

## âš¡ è§¦å‘å™¨è®¾è®¡

### è‡ªåŠ¨æ›´æ–°æ—¶é—´è§¦å‘å™¨

```sql
-- è§¦å‘å™¨å‡½æ•°ï¼šè‡ªåŠ¨æ›´æ–° updated_at å­—æ®µ
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- ç”¨æˆ·è¡¨è§¦å‘å™¨
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- æ–‡ç« è¡¨è§¦å‘å™¨
CREATE TRIGGER update_posts_updated_at
    BEFORE UPDATE ON posts
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### è§¦å‘å™¨æ‰§è¡Œæ—¶æœº
- **BEFORE UPDATE**: åœ¨æ›´æ–°æ“ä½œæ‰§è¡Œå‰è‡ªåŠ¨è®¾ç½®æ—¶é—´
- **FOR EACH ROW**: æ¯è¡Œæ›´æ–°éƒ½ä¼šè§¦å‘
- **è‡ªåŠ¨ç»´æŠ¤**: æ— éœ€åº”ç”¨å±‚æ‰‹åŠ¨ç®¡ç†æ—¶é—´å­—æ®µ

---

## ğŸ›¡ï¸ æ•°æ®å®Œæ•´æ€§ä¿éšœ

### çº¦æŸè®¾è®¡

#### ä¸»é”®çº¦æŸ
- æ¯ä¸ªè¡¨éƒ½æœ‰è‡ªå¢ä¸»é”® (`SERIAL`)
- ä¿è¯è¡Œçš„å”¯ä¸€æ€§å’Œå¼•ç”¨å®Œæ•´æ€§

#### å”¯ä¸€çº¦æŸ
```sql
-- ç”¨æˆ·è¡¨å”¯ä¸€çº¦æŸ
ALTER TABLE users ADD CONSTRAINT uk_users_email UNIQUE (email);
ALTER TABLE users ADD CONSTRAINT uk_users_username UNIQUE (username);
```

#### å¤–é”®çº¦æŸ
```sql
-- æ–‡ç« è¡¨å¤–é”®çº¦æŸ
ALTER TABLE posts ADD CONSTRAINT fk_posts_user_id
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

#### æ£€æŸ¥çº¦æŸ (å¯é€‰æ‰©å±•)
```sql
-- æ–‡ç« çŠ¶æ€çº¦æŸ
ALTER TABLE posts ADD CONSTRAINT ck_posts_status
    CHECK (status IN ('draft', 'published', 'archived'));

-- é‚®ç®±æ ¼å¼çº¦æŸ
ALTER TABLE users ADD CONSTRAINT ck_users_email_format
    CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');
```

---

## ğŸ“Š æŸ¥è¯¢æ€§èƒ½åˆ†æ

### å¸¸è§æŸ¥è¯¢æ¨¡å¼

#### 1. ç”¨æˆ·è®¤è¯æŸ¥è¯¢
```sql
-- ç™»å½•éªŒè¯æŸ¥è¯¢ (ä½¿ç”¨ idx_users_username)
EXPLAIN ANALYZE
SELECT id, password_hash, is_active
FROM users
WHERE username = $1 AND is_active = true;
```

#### 2. æ–‡ç« åˆ—è¡¨æŸ¥è¯¢
```sql
-- å·²å‘å¸ƒæ–‡ç« åˆ—è¡¨ (ä½¿ç”¨ idx_posts_status, idx_posts_published_at)
EXPLAIN ANALYZE
SELECT p.*, u.username
FROM posts p
JOIN users u ON p.user_id = u.id
WHERE p.status = 'published'
ORDER BY p.published_at DESC
LIMIT 10 OFFSET 0;
```

#### 3. ç”¨æˆ·æ–‡ç« æŸ¥è¯¢
```sql
-- ç”¨æˆ·æ‰€æœ‰æ–‡ç«  (ä½¿ç”¨ idx_posts_user_id)
EXPLAIN ANALYZE
SELECT * FROM posts
WHERE user_id = $1
ORDER BY created_at DESC;
```

### æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

#### åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µæ›¿ä»£ OFFSET (å¤§æ•°æ®é‡æ—¶)
SELECT * FROM posts
WHERE published_at < $1 AND status = 'published'
ORDER BY published_at DESC
LIMIT 10;
```

#### è¿æ¥æŸ¥è¯¢ä¼˜åŒ–
```sql
-- é¢„åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œå‡å°‘N+1æŸ¥è¯¢
SELECT
    p.id, p.title, p.content, p.status,
    p.published_at, p.created_at,
    u.username, u.full_name
FROM posts p
INNER JOIN users u ON p.user_id = u.id
WHERE p.status = 'published'
ORDER BY p.published_at DESC;
```

---

## ğŸ”§ sqlc é›†æˆé…ç½®

### sqlc.yaml é…ç½®
```yaml
version: "2"
sql:
  - engine: "postgresql"
    queries: "internal/db/queries"
    schema: "migrations"
    gen:
      go:
        package: "sqlc"
        out: "internal/db/sqlc"
        sql_package: "pgx/v5"
        emit_json_tags: true
        emit_prepared_queries: false
        emit_interface: true
        emit_exact_table_names: false
```

### æŸ¥è¯¢æ–‡ä»¶ç¤ºä¾‹ (internal/db/queries/)

#### users.sql
```sql
-- name: CreateUser :one
INSERT INTO users (email, username, password_hash, full_name)
VALUES ($1, $2, $3, $4)
RETURNING *;

-- name: GetUserByUsername :one
SELECT * FROM users
WHERE username = $1 AND is_active = true;

-- name: GetUserByEmail :one
SELECT * FROM users
WHERE email = $1 AND is_active = true;

-- name: ListUsers :many
SELECT * FROM users
WHERE is_active = true
ORDER BY created_at DESC
LIMIT $1 OFFSET $2;
```

#### posts.sql
```sql
-- name: CreatePost :one
INSERT INTO posts (user_id, title, content, status)
VALUES ($1, $2, $3, $4)
RETURNING *;

-- name: GetPost :one
SELECT * FROM posts WHERE id = $1;

-- name: ListPublishedPosts :many
SELECT * FROM posts
WHERE status = 'published'
ORDER BY published_at DESC
LIMIT $1 OFFSET $2;

-- name: UpdatePost :one
UPDATE posts
SET title = COALESCE($2, title),
    content = COALESCE($3, content),
    status = COALESCE($4, status),
    published_at = CASE
        WHEN $4 = 'published' AND status != 'published'
        THEN CURRENT_TIMESTAMP
        ELSE published_at
    END
WHERE id = $1
RETURNING *;
```

---

## ğŸ“ˆ æ•°æ®åº“ç»´æŠ¤

### è¿ç§»ç®¡ç†
```bash
# åˆ›å»ºæ–°è¿ç§»
migrate create -ext sql -dir migrations -seq add_user_avatar

# æ‰§è¡Œè¿ç§»
migrate -path migrations -database "postgres://..." up

# å›æ»šè¿ç§»
migrate -path migrations -database "postgres://..." down 1
```

### æ€§èƒ½ç›‘æ§
```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, mean_time, calls
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT schemaname, tablename, attname, n_distinct, correlation
FROM pg_stats
WHERE schemaname = 'public';
```

### å¤‡ä»½ç­–ç•¥
```bash
# æ•°æ®åº“å¤‡ä»½
pg_dump -h localhost -U username -d database_name > backup.sql

# æ•°æ®åº“æ¢å¤
psql -h localhost -U username -d database_name < backup.sql
```

---

## ğŸ”® æ‰©å±•è§„åˆ’

### å¯èƒ½çš„è¡¨æ‰©å±•

#### ç”¨æˆ·å¤´åƒè¡¨ (user_avatars)
```sql
CREATE TABLE user_avatars (
    user_id INTEGER PRIMARY KEY REFERENCES users(id),
    avatar_url VARCHAR(500),
    uploaded_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

#### æ–‡ç« åˆ†ç±»è¡¨ (categories)
```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    description TEXT
);

-- æ–‡ç« åˆ†ç±»å…³è”è¡¨
CREATE TABLE post_categories (
    post_id INTEGER REFERENCES posts(id),
    category_id INTEGER REFERENCES categories(id),
    PRIMARY KEY (post_id, category_id)
);
```

#### æ–‡ç« è¯„è®ºè¡¨ (comments)
```sql
CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    post_id INTEGER NOT NULL REFERENCES posts(id),
    user_id INTEGER NOT NULL REFERENCES users(id),
    content TEXT NOT NULL,
    parent_id INTEGER REFERENCES comments(id),
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);
```

### æ€§èƒ½ä¼˜åŒ–æ–¹å‘
1. **è¯»å†™åˆ†ç¦»**: ä¸»ä»å¤åˆ¶é…ç½®
2. **è¿æ¥æ± ä¼˜åŒ–**: pgbouncer é›†æˆ
3. **æŸ¥è¯¢ç¼“å­˜**: Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
4. **åˆ†åŒºè¡¨**: å¤§æ•°æ®é‡æ—¶çš„æ°´å¹³åˆ†åŒº

---

*æœ¬æ–‡æ¡£éšæ•°æ®åº“ç»“æ„æ¼”è¿›æŒç»­æ›´æ–°ï¼Œç¡®ä¿ä¸å®é™…å®ç°ä¿æŒåŒæ­¥ã€‚*